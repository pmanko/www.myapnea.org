<div id="dashboard">
<div class="page-header">
  <h1><%= current_user.first_name %>'s Dashboard</h1>
</div>

<div class="row">
  <div class="col-md-12">
    <h2>Questionnaires</h2>
    <div id="questionnaires" class="list-group">
      <% QuestionFlow.where(status: "show").order('id').each do |qf| %>
        <% as = AnswerSession.most_recent(qf.id, current_user.id) %>
        <% if as and as.completed? %>
          <div class="list-group-item">
            <h3><%= qf.name %></h3>
            <p><strong>Questionnaire finished!</strong></p>
            <div>
              <%= link_to 'Review Answers', finished_answer_session_path(answer_session_id: as.id), class: 'btn btn-default btn-sm' %>
              <%= link_to 'Retake Questionnaire', start_answer_session_path(question_flow_id: qf.id), class: 'btn btn-default btn-sm', data: {confirm: "Are you sure you want to retake the questionnaire?", description: "All your progress will be lost, and you'll have complete the questionnaire again."} %>
            </div>
          </div>
        <% else %>
          <%= link_to start_or_resume(qf, as), class: 'list-group-item' do %>
            <h3><%= qf.name %></h3>
            <% if as.present? and as.started? %>
              <%=  render partial: 'answer_sessions/session_progress', locals: {stats: as.calculate_status_stats, question_flow: qf} %>
            <% else %>
              <p>Questionnaire not yet started.</p>
              <p><strong>Estimated time commitment:</strong> <%= qf.total_time.ceil %> minutes for <%= qf.all_questions.length %> questions.</p>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
    <div class="row">
      <div class="col-md-4">
        <h2>Daily Trends</h2>
        <p class="text-info">Keep track of your health with daily updates!</p>

        <%= form_tag process_answer_path, {role: 'form', class: "form-inline"} do %>
          <div class="list-group">
            <% @daily_questions.each do |q| %>
              <div class="form-group">
                <label for="question_<%= q.id %>"><%= q.text %></label>
                <% if q.question_type.id == 6 %>
                  <input type="number" class="form-control" id="question_<%= q.id %>">
                <% else %>
                  <select class="form-control" id="question_<%= q.id %>">
                    <% q.answer_options.each do |ao| %>
                      <option value="<%= ao.id %>"><%= ao.text_value %></option>
                    <% end %>
                  </select>
                <% end %>


              </div>


            <% end %>
          </div>
        <% end %>
      </div>
      <div class="col-md-8">
        <div id="daily-trends-chart">

        </div>

      </div>
    </div>



  </div>
</div>
</div>


<script>

  var margin = {top: 20, right: 20, bottom: 30, left: 50},
      width = 750 - margin.left - margin.right,
      height = 350 - margin.top - margin.bottom;

  var parseDate = d3.time.format("%d-%b-%y").parse;

  var x = d3.time.scale()
      .range([0, width]);

  var y = d3.scale.linear()
      .range([height, 0]);

  var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom");

  var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left");

  var line = d3.svg.line()
      .x(function(d) { return x(d.date); })
      .y(function(d) { return y(d.close); });

  var svg = d3.select("#daily-trends-chart").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  d3.tsv("/data.tsv", function(error, data) {
    data.forEach(function(d) {
      d.date = parseDate(d.date);
      d.close = +d.close;
    });

    x.domain(d3.extent(data, function(d) { return d.date; }));
    y.domain(d3.extent(data, function(d) { return d.close; }));

    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis)
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", ".71em")
        .style("text-anchor", "end")
        .text("Price ($)");

    svg.append("path")
        .datum(data)
        .attr("class", "line")
        .attr("d", line);
  });

</script>